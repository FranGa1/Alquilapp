<div class="mb-10vh mt-10vh d-flex justify-content-center flex-column align-items-center">
    <% if @minutos_restantes > 0 %>
        <% if @minutos_restantes <= 5 %>
            <div class="alert alert-danger alert-dismissible fade show p-2 w-80" role="alert" style="margin-bottom:1px">
                <strong>¡Atención!</strong> Tu tiempo de alquiler ha finalizado, como no has devuelto el vehículo, se te ha cobrado una multa. Puedes devolver el vehiculo ahora o prolongar el alquiler
            </div>
        <% elsif @minutos_restantes <= 15 %>
            <div class="alert alert-warning alert-dismissible fade show p-2 w-80" role="alert" style="margin-bottom:1px">
                <strong>¡Atención!</strong> Te quedan menos de <%=@minutos_restantes%> minutos de alquiler
            </div>
        <%end%>
    <%end%>
    <div class="d-flex flex-column " style="width:80%">
         <%= render "users/shared/error_messages", resource: current_user%>
        <h4 class="p-2 align-self-start">Tu alquiler, <%=current_user.first_name %></h4>

        <div id="liveAlertPlaceholder"></div>

        <a class="card align-self-center text-black shadow" style="width: 16rem; text-decoration: none" href="/users/vehiculo/<%=@auto.id%>">
            <%if @auto.imagen.attached?%>
                <%= image_tag(@auto.imagen) %></td>
            <%else%>
                <label>Sin Foto</label>
            <%end%>
            <div class="card-body">
                <h5 class="card-title"><%=@auto.modelo%> <%=@auto.anio%></h5>
                <p class="card-text"><%=@auto.patente%></p>
            </div>
        </a>

        <div class="mt-4">
            <h5>Tiempo restante:</h5>
                <h4><div class="text-center pt-2 bold" id="countdown" style="color: #000000"></div></h4>
        </div>


        <div class="mt-4 align-self-center">
            <button type="button" class="btn btn-success rounded-5">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-patch-check me-1 mb-1 ms-2" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M10.354 6.146a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 1 1 .708-.708L7 8.793l2.646-2.647a.5.5 0 0 1 .708 0z"/>
                    <path d="m10.273 2.513-.921-.944.715-.698.622.637.89-.011a2.89 2.89 0 0 1 2.924 2.924l-.01.89.636.622a2.89 2.89 0 0 1 0 4.134l-.637.622.011.89a2.89 2.89 0 0 1-2.924 2.924l-.89-.01-.622.636a2.89 2.89 0 0 1-4.134 0l-.622-.637-.89.011a2.89 2.89 0 0 1-2.924-2.924l.01-.89-.636-.622a2.89 2.89 0 0 1 0-4.134l.637-.622-.011-.89a2.89 2.89 0 0 1 2.924-2.924l.89.01.622-.636a2.89 2.89 0 0 1 4.134 0l-.715.698a1.89 1.89 0 0 0-2.704 0l-.92.944-1.32-.016a1.89 1.89 0 0 0-1.911 1.912l.016 1.318-.944.921a1.89 1.89 0 0 0 0 2.704l.944.92-.016 1.32a1.89 1.89 0 0 0 1.912 1.911l1.318-.016.921.944a1.89 1.89 0 0 0 2.704 0l.92-.944 1.32.016a1.89 1.89 0 0 0 1.911-1.912l-.016-1.318.944-.921a1.89 1.89 0 0 0 0-2.704l-.944-.92.016-1.32a1.89 1.89 0 0 0-1.912-1.911l-1.318.016z"/>
                </svg>
                <%= link_to "Certificado", "/users/certificado", style: "text-decoration: none; color: white", class: "me-2"%>
            </button>
        </div>



        <div class="container map-bottom text-center" id="botones">
            <div class="row">

                <div class="col">
                    <button type="button" class="btn btn-warning rounded-5 shadow">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="#FFFFFF" class="bi bi-key me-2 mb-1" viewBox="0 0 16 16">
                            <path d="M0 8a4 4 0 0 1 7.465-2H14a.5.5 0 0 1 .354.146l1.5 1.5a.5.5 0 0 1 0 .708l-1.5 1.5a.5.5 0 0 1-.708 0L13 9.207l-.646.647a.5.5 0 0 1-.708 0L11 9.207l-.646.647a.5.5 0 0 1-.708 0L9 9.207l-.646.647A.5.5 0 0 1 8 10h-.535A4 4 0 0 1 0 8zm4-3a3 3 0 1 0 2.712 4.285A.5.5 0 0 1 7.163 9h.63l.853-.854a.5.5 0 0 1 .708 0l.646.647.646-.647a.5.5 0 0 1 .708 0l.646.647.646-.647a.5.5 0 0 1 .708 0l.646.647.793-.793-1-1h-6.63a.5.5 0 0 1-.451-.285A3 3 0 0 0 4 5z"/>
                            <path d="M4 8a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
                        </svg>
                        <% if @auto.is_open? %>
                            <%= link_to "Cerrar auto", "/abrir_cerrar/#{@auto.id}/", style: "text-decoration: none; color: white"%>
                        <% else %>
                            <%= link_to "Abrir auto", "/abrir_cerrar/#{@auto.id}/", style: "text-decoration: none; color: white"%>
                        <% end %>
                    </button>
                </div>

                <div class="col" >
                    <% if !@auto.is_open? %>
                        <button type="button" class="btn btn-danger rounded-5 me-1 shadow" data-bs-toggle="modal" data-bs-target="#exampleModal">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x-circle me-1 mb-1 ms-4" viewBox="0 0 16 16">
                                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                                <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
                            </svg>
                            <span class="me-3">Finalizar</span>
                        </button>
                    <% else %>
                        <button disabled type="button" class="btn btn-danger rounded-5 me-1 shadow" id="liveAlertBtn">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x-circle me-1 mb-1 ms-4" viewBox="0 0 16 16">
                                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                                <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
                            </svg>
                            <span class="me-3">Finalizar</span>
                        </button>
                    <% end %>
                </div>



            </div>
        </div>


    </div>
    <button  id="btn-confirm" class="btn btn-warning rounded-4 fs-5 p-2 text-white floating_btn" data-bs-toggle="modal" data-bs-target="#modalProlongar" data-bs-whatever="">Prolongar alquiler</button>
    <div class="modal fade" id="modalProlongar" tabindex="-1" aria-labelledby="modalProlongarLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalProlongarLabel">Prolongar el alquiler</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <% @a = Alquiler.new %>
                    <%= form_with model: @alquiler, url: "/users/prolongar_alquiler", method: :put do |form| %>
                    <%= form.label "Fecha de Devolucion", required: true, class:"" %>
                    <%= form.date_field :fecha_devolucion, class: "form-control", required: true, id:"datefield", min:'2022-01-01', max:'2122-01-01' %>
                    <%= form.label "Hora de Devolucion", required: true, class:"" %>
                    <%= form.time_field :hora_devolucion, class: "form-control", required: true, id:"timefield", min:'00:00'%>
                    <div id="current_price" class="text-success text-center p-3 fs-5"></div>
                    <p class="text-center" id="text-confirm"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <%= form.submit "Alquilar", class: "btn btn-success mt-2", id:"btn-yes" %>
                </div>
                <%end%>

                <div class="ms-2 me-2" id="recordatorio"></div>
            </div>
        </div>
    </div>



</div>

<!--MODAL-->
<div class="modal fade mt-5" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
    <div class="modal-content">
        <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Finalizar alquiler</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body m-2">
        <p>¿Está seguro que desea finalizar el alquiler del <strong><%=@auto.modelo%></strong>?</p>
        </div>
        <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <%= button_to "Finalizar", "/users/finalizar_alquiler", method: :put, class:"btn btn-danger"%>
        </div>
        <div class="alert alert-danger alert-dismissible fade show p-2 mt-2" role="alert" id="recordatorio${id}">
                            <strong>¡Recordatorio!</strong>El precio final del alquiler se calcula sobre las horas de reserva, no sobre las horas de uso.
                        </div>
    </div>
    </div>
</div>

<script>
    var today = new Date();
    var actual_time = today.getHours() + ":" + today.getMinutes();

    if (today.getMinutes() < 10) {
        actual_time = today.getHours() + ":0" + today.getMinutes();
    }
    if (today.getHours() < 10) {
        actual_time = "0" + today.getHours() + ":" + today.getMinutes();
    }

    document.getElementById("text-confirm").innerHTML = "Ingrese horario y fecha de devolución para ver el precio";
    var dd = today.getDate();
    var mm = today.getMonth() + 1; //January is 0!
    var yyyy = today.getFullYear();
    // console.log(today+0);
    var today_plus_ten_days = new Date(today.getTime() + 10 * 24 * 60 * 60 * 1000);
    var dd_plus_ten_days = today_plus_ten_days.getDate();
    var mm_plus_ten_days = today_plus_ten_days.getMonth() + 1; //January is 0!
    var yyyy_plus_ten_days = today_plus_ten_days.getFullYear();
    if (dd < 10) {
      dd = '0' + dd;
    }
    if (mm < 10) {
      mm = '0' + mm;
    }
    today = yyyy + '-' + mm + '-' + dd;
    if (dd_plus_ten_days < 10) {
      dd_plus_ten_days = '0' + dd_plus_ten_days;
    }
    if (mm_plus_ten_days < 10) {
      mm_plus_ten_days = '0' + mm_plus_ten_days;
    }
    today_plus_ten_days = yyyy_plus_ten_days + '-' + mm_plus_ten_days + '-' + dd_plus_ten_days;

    // function actualizarPrecio(){
    //     var date_value = today;
    //         if (date != null){
    //             date_value = date.value;
    //         }

    //         var difference_of_hours_between_today_and_date_value = (new Date(date_value).getTime() - new Date(today).getTime()) / 1000 / 60 / 60;
    //         console.log(difference_of_hours_between_today_and_date_value);

    //         // round to the higher integer the value of minutes and store it in a variable
    //         var minutes = Math.round(time.value.split(":")[1]/60 - parseInt(actual_time.split(":")[1])/60);

    //         console.log(minutes)
    //         // get the value of hours and store it in a variable
    //         var hours = parseInt(time.value.split(":")[0]) - parseInt(actual_time.split(":")[0]);
    //         // round hours to the higher integer if its positive and to the lower integer if its negative

    //         console.log(hours)
    //         var total_hours = hours + minutes + difference_of_hours_between_today_and_date_value;
    //         console.log(total_hours);
    //         if (total_hours <= 0){
    //             document.getElementById("btn-yes").disabled = true;
    //             // document.getElementById("btn-yes").setAttribute("href", "#");
    //             alert("La hora de devolución debe ser mayor a la hora actual");
    //             document.getElementById("current_price").innerHTML = "";
    //             document.getElementById("text-confirm").innerHTML = "Ingrese un horario válido";
    //         }
    //         else if (time.value != "") {
    //             document.getElementById("btn-yes").disabled = false;
    //             // document.getElementById("btn-yes").setAttribute("href", "#");
    //             //round to 2 decimal places
    //             var price = Math.round((total_hours * <%= Precio.last.valor %>) * 100) / 100;
    //             document.getElementById("current_price").innerHTML = "Costo total: <b>&#36;" + price +"</b>";
    //             document.getElementById("text-confirm").innerHTML = "¿Está seguro que desea alquilar al <%= @auto.modelo %>?";
    //             document.getElementById("recordatorio").innerHTML = `
    //                     <div class="alert alert-success alert-dismissible fade show p-2 mt-2" role="alert" id="recordatorio">
    //                         <strong>¡Recordatorio!</strong>  Recuerda que el precio del alquiler se computa por hora, por lo que 1:01 hs costará lo mismo que 2hs.
    //                     </div>`;
    //         }
    // }

    var date = document.getElementById("datefield");
    if (date != null){
      date.setAttribute("min", today);
      date.setAttribute("max", today_plus_ten_days);
      date.addEventListener("change", actualizarPrecio);
    }
    var time = document.getElementById("timefield");
    console.log(time)
    if (time != null){
      time.setAttribute("value", "");
    //   time.setAttribute("step", "3600");
        time.addEventListener("change", actualizarPrecio);
    }

    //delete alert after 5 seconds
    setTimeout(function() {
        $('#liveAlertPlaceholder').alert('close');
    }, 5000);

    //delete alert after 5 seconds

    const alertPlaceholder = document.getElementById('liveAlertPlaceholder')

    const alert = (message, type) => {
    const wrapper = document.createElement('div')
    wrapper.innerHTML = [
        `<div class="alert alert-${type} alert-dismissible" role="alert">`,
        `   <div>${message}</div>`,
        '   <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>',
        '</div>'
    ].join('')

    alertPlaceholder.append(wrapper)
    }

    const alertTrigger = document.getElementById('liveAlertBtn')
    if (alertTrigger) {
    alertTrigger.addEventListener('click', () => {
        alert('Las puertas del auto están abiertas! Cierralas para poder finalizar', 'danger')
    })

    }

    // function that given a month number return the first three letters of the month
    function getMonthName(monthNumber) {
        var monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun",
            "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"
        ];
        return monthNames[monthNumber-1];
    }

   // Set the date we're counting down to
   var month = <%= @alquiler.fecha_devolucion.month %>
    var day = "<%= @alquiler.fecha_devolucion.day %>"
    var year = "<%= @alquiler.fecha_devolucion.year %>"

    var countDownDate = new Date(`${getMonthName(month)} ${day}, ${year} <%= @tiempo_fin %>`).getTime();
    // Update the count down every 1 second
    var x = setInterval(function() {

        // Get today's date and time
        var now = new Date().getTime();
        // format and display now


        // Find the distance between now and the count down date
        var distance = countDownDate - now;


        // Time calculations for days, hours, minutes and seconds
        var days = Math.floor(distance / (1000 * 60 * 60 * 24));
        var hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        var minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        var seconds = Math.floor((distance % (1000 * 60)) / 1000);

        //If the count is less than 15 minutes, change the color to red
        if (distance < 900000 && distance > 300000) {
            document.getElementById("countdown").style.color = "red";
        }
        // // else, if the count is less than 5 minutes, alternate color
        else if (distance <= 300000) {
            if (document.getElementById("countdown").style.color == "red") {
                document.getElementById("countdown").style.color = "black";
            } else {
                document.getElementById("countdown").style.color = "red";
            }
        }

        // Display the result in the element with id="demo"
        document.getElementById("countdown").innerHTML =  days + "d " +  hours + "h "
        + minutes + "m " + seconds + "s ";

        // If the count down is finished, write some text
        if (distance < 0) {
            clearInterval(x);
            document.getElementById("countdown").innerHTML = "Tiempo finalizado";
        }
    }, 1000);

</script>
